@using NoLock.Social.Core.Camera.Models
@using NoLock.Social.Core.ImageProcessing.Models

<div class="enhancement-preview">
    @if (IsLoading)
    {
        <div class="preview-loading">
            <div class="loading-spinner"></div>
            <p>Processing enhancement...</p>
        </div>
    }
    else
    {
        <div class="preview-header">
            <h3>Enhancement Preview</h3>
            <div class="comparison-toggle">
                <label class="toggle-switch">
                    <input type="checkbox" @bind="ShowSideBySide" />
                    <span class="slider"></span>
                </label>
                <span>@(ShowSideBySide ? "Side by Side" : "Overlay")</span>
            </div>
        </div>

        <div class="image-comparison @(ShowSideBySide ? "side-by-side" : "overlay")">
            @if (ShowSideBySide)
            {
                <div class="comparison-side-by-side">
                    <div class="image-container original">
                        <h4>Original</h4>
                        <img src="@GetImageSource(OriginalImage?.ImageData)" alt="Original image" />
                        @if (OriginalImage != null)
                        {
                            <div class="quality-badge original">Quality: @OriginalImage.Quality</div>
                        }
                    </div>
                    <div class="image-container enhanced">
                        <h4>Enhanced</h4>
                        <img src="@GetImageSource(EnhancementResult?.EnhancedImageData)" alt="Enhanced image" />
                        @if (EnhancementResult != null)
                        {
                            <div class="quality-badge enhanced">Quality: @EnhancementResult.QualityScore</div>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="comparison-overlay">
                    <div class="overlay-container">
                        <img src="@GetImageSource(OriginalImage?.ImageData)" alt="Original image" class="base-image" />
                        <img src="@GetImageSource(EnhancementResult?.EnhancedImageData)" alt="Enhanced image" 
                             class="overlay-image" style="opacity: @OpacityValue" />
                    </div>
                    <div class="opacity-control">
                        <label>Enhanced Opacity:</label>
                        <input type="range" min="0" max="1" step="0.1" @bind="OpacityValue" @bind:event="oninput" />
                        <span>@((OpacityValue * 100).ToString("F0"))%</span>
                    </div>
                </div>
            }
        </div>

        @if (EnhancementResult?.AppliedOperations != null && EnhancementResult.AppliedOperations.Any())
        {
            <div class="enhancement-details">
                <h4>Applied Enhancements</h4>
                <div class="operations-list">
                    @foreach (var operation in EnhancementResult.AppliedOperations)
                    {
                        <div class="operation-item @(operation.IsSuccessful ? "success" : "failed")">
                            <div class="operation-header">
                                <span class="operation-name">@GetOperationDisplayName(operation.OperationType)</span>
                                <span class="operation-status">
                                    @if (operation.IsSuccessful)
                                    {
                                        <span class="status-icon success">✓</span>
                                    }
                                    else
                                    {
                                        <span class="status-icon failed">✗</span>
                                    }
                                </span>
                            </div>
                            <div class="operation-metrics">
                                <span class="processing-time">@operation.ProcessingTimeMs ms</span>
                                @if (operation.IsSuccessful)
                                {
                                    <span class="quality-improvement @(operation.QualityImprovement > 0 ? "positive" : "negative")">
                                        @(operation.QualityImprovement > 0 ? "+" : "")@operation.QualityImprovement
                                    </span>
                                }
                            </div>
                            @if (!operation.IsSuccessful && !string.IsNullOrEmpty(operation.ErrorMessage))
                            {
                                <div class="error-message">@operation.ErrorMessage</div>
                            }
                        </div>
                    }
                </div>
            </div>
        }

        <div class="quality-summary">
            <div class="quality-metric">
                <span class="metric-label">Original Quality:</span>
                <span class="metric-value">@(OriginalImage?.Quality ?? 0)</span>
            </div>
            <div class="quality-metric">
                <span class="metric-label">Enhanced Quality:</span>
                <span class="metric-value">@(EnhancementResult?.QualityScore ?? 0)</span>
            </div>
            <div class="quality-metric improvement">
                <span class="metric-label">Improvement:</span>
                <span class="metric-value @(QualityImprovement > 0 ? "positive" : "negative")">
                    @(QualityImprovement > 0 ? "+" : "")@QualityImprovement
                </span>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-success" @onclick="AcceptEnhancements" disabled="@(!IsValidResult)">
                Accept Enhancements
            </button>
            <button class="btn btn-secondary" @onclick="RejectEnhancements">
                Reject & Use Original
            </button>
            @if (EnhancementResult?.AppliedOperations != null && EnhancementResult.AppliedOperations.Count > 1)
            {
                <button class="btn btn-outline" @onclick="ShowIndividualOperations">
                    Apply Individual Operations
                </button>
            }
        </div>
    }
</div>

@code {
    [Parameter] public CapturedImage? OriginalImage { get; set; }
    [Parameter] public EnhancementResult? EnhancementResult { get; set; }
    [Parameter] public EventCallback OnAccepted { get; set; }
    [Parameter] public EventCallback OnRejected { get; set; }
    [Parameter] public bool IsLoading { get; set; }

    private bool ShowSideBySide { get; set; } = true;
    private double OpacityValue { get; set; } = 0.5;

    private bool IsValidResult => EnhancementResult?.IsSuccessful == true && 
                                  !string.IsNullOrEmpty(EnhancementResult.EnhancedImageData);

    private int QualityImprovement => (EnhancementResult?.QualityScore ?? 0) - (OriginalImage?.Quality ?? 0);

    private string GetImageSource(string? imageData)
    {
        if (string.IsNullOrEmpty(imageData))
            return "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==";
        
        return imageData.StartsWith("data:") ? imageData : $"data:image/jpeg;base64,{imageData}";
    }

    private string GetOperationDisplayName(EnhancementOperationType operationType)
    {
        return operationType switch
        {
            EnhancementOperationType.ContrastAdjustment => "Contrast Adjustment",
            EnhancementOperationType.ShadowRemoval => "Shadow Removal",
            EnhancementOperationType.PerspectiveCorrection => "Perspective Correction",
            EnhancementOperationType.GrayscaleConversion => "Grayscale Conversion",
            EnhancementOperationType.NoiseReduction => "Noise Reduction",
            EnhancementOperationType.Sharpening => "Sharpening",
            _ => operationType.ToString()
        };
    }

    private async Task AcceptEnhancements()
    {
        if (IsValidResult)
        {
            await OnAccepted.InvokeAsync();
        }
    }

    private async Task RejectEnhancements()
    {
        await OnRejected.InvokeAsync();
    }

    private void ShowIndividualOperations()
    {
        // TODO: Implement individual operation selection in future iteration
        // This would allow users to cherry-pick specific enhancements
    }
}